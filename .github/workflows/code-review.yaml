name: Code Review

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize]
    paths:
      - apps/**
      - packages/**
      - .node-version

jobs:
  js_code_review:
    uses: pagopa/dx/.github/workflows/js_code_review.yaml@acbe3f70840ac84fe36e15a115a61fcf4aa6ada1
    name: Code Review
    secrets: inherit

  coverage:
    name: Coverage Report
    needs: [js_code_review]
    runs-on: ubuntu-latest
    steps:
      - name: 'Report Vehicles Frontend Coverage'
        uses: davelosert/vitest-coverage-report-action@9fd25c0d0394bfd0ffa632777316402c2e5fb81f # v2.0.4
        if: ${{ hashFiles('./apps/vehicles/coverage/frontend/*.json') != '' }}
        with:
          name: 'Vehicles Frontend'
          working-directory: './apps/vehicles'
          vite-config-path: './vitest/vitest.config.react.mjs'
          json-summary-path: 'coverage/frontend/coverage-summary.json'
          json-final-path: 'coverage/frontend/coverage-final.json'

      - name: 'Report Vehicles Backend Coverage'
        uses: davelosert/vitest-coverage-report-action@9fd25c0d0394bfd0ffa632777316402c2e5fb81f # v2.0.4
        if: ${{ hashFiles('./apps/vehicles/coverage/backend/*.json') != '' }}
        with:
          name: 'Vehicles Backend'
          working-directory: './apps/vehicles'
          vite-config-path: './vitest/vitest.config.node.mjs'
          json-summary-path: 'coverage/backend/coverage-summary.json'
          json-final-path: 'coverage/backend/coverage-final.json'
